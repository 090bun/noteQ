(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[867],{5231:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>G});var n=a(5155),l=a(2115),o=a(6153),s=a(7771);function r(e){var t,a,l,o;let{styles:s,quiz:r,stats:i}=e;return(0,n.jsx)("div",{id:"results",className:s["results-section"],children:(0,n.jsx)("div",{className:"container",children:(0,n.jsxs)("div",{className:s["results-card"],children:[(0,n.jsx)("h2",{className:s["results-title"],children:"挑戰結果"}),(0,n.jsxs)("p",{className:s["results-summary"],children:["答對題數",null!=(t=null==i?void 0:i.correct)?t:0,"/",null!=(a=null==i?void 0:i.total)?a:0,(0,n.jsx)("br",{}),"正確率：",(null!=(l=null==i?void 0:i.accuracy)?l:0).toFixed?i.accuracy.toFixed(1):null!=(o=null==i?void 0:i.accuracy)?o:0,"%"]})]})})})}var i=a(6766);function c(e){var t,a,l;let{number:o,question:s,onOpenFavoriteModal:r,onOpenAnalysis:c,styles:u,isPlusSubscribed:d}=e,m=null!=(t=null==s?void 0:s.status)?t:(null==s?void 0:s.isCorrect)?"correct":"wrong",v=u[m]||("correct"===m?u.correct||u.success:u.wrong||u.error||u.incorrect),_=s.question||s.title||"",f=s.userAnswer||s.userSelected||null,p=s.correctAnswer||s.aiAnswer||null,y=s.options||{A:s.options_A,B:s.options_B,C:s.options_C,D:s.options_D},g=f?null!=(a=null==y?void 0:y[f])?a:f:"",h=p?null!=(l=null==y?void 0:y[p])?l:p:"";return(0,n.jsxs)("article",{className:u["question-card"],"data-question":o,children:[(0,n.jsxs)("header",{className:u["card-header"],children:[(0,n.jsx)("h3",{className:u["card-title"],children:"題目詳情"}),(0,n.jsx)("div",{className:"".concat(u["status-tag"]," ").concat(v),children:s.isCorrect?"✓ 正確":"x 錯誤"})]}),(0,n.jsxs)("div",{className:u["card-body"],children:[(0,n.jsxs)("p",{className:"question-number",children:["第 ",o," 題"]}),(0,n.jsxs)("p",{className:"question-text",children:["題目: ",_]}),(0,n.jsxs)("p",{className:"answer-text",children:["您的答案: ",g]}),(0,n.jsxs)("p",{className:"answer-text",children:["正確答案: ",h]})]}),d?(0,n.jsxs)("footer",{className:u["card-actions"],children:[(0,n.jsxs)("button",{className:"".concat(u["action-btn"]," ").concat(u["btn-favorite"]),onClick:r,children:[(0,n.jsx)(i.default,{src:"/img/Vector-11.png",alt:"",width:15,height:15}),(0,n.jsx)("span",{children:"收藏"})]}),(0,n.jsxs)("button",{className:"".concat(u["action-btn"]," ").concat(u["btn-analysis"]),onClick:c,children:[(0,n.jsx)(i.default,{src:"/img/Vector-10.png",alt:"",width:15,height:15}),(0,n.jsx)("span",{children:"解析"})]})]}):(0,n.jsx)("footer",{className:u["card-actions"],children:(0,n.jsx)("div",{className:u["upgrade-notice"],children:(0,n.jsx)("span",{children:"升級Plus方案解鎖收藏和解析功能"})})})]})}function u(e){let{questionData:t,onOpenFavoriteModal:a,onOpenAnalysis:o,styles:s,isPlusSubscribed:r}=e,i=(0,l.useRef)(null);(0,l.useEffect)(()=>{let e=i.current;if(!e)return;let t=e=>{a(e.detail.questionNumber)},n=()=>{o()};return e.addEventListener("favoriteClick",t),e.addEventListener("analysisClick",n),()=>{e.removeEventListener("favoriteClick",t),e.removeEventListener("analysisClick",n)}},[t,a,o]);let u=Array.isArray(t)?t.map((e,t)=>[t+1,e]):Object.entries(t||{});return(0,n.jsx)("div",{id:"details",className:"details-section",children:(0,n.jsx)("div",{className:"container",children:(0,n.jsx)("div",{ref:i,className:s["questions-grid"],children:u.map(e=>{let[t,l]=e;return(0,n.jsx)(c,{number:t,question:l,onOpenFavoriteModal:()=>a(t),onOpenAnalysis:()=>o(t),styles:s,isPlusSubscribed:r},t)})})})})}var d=a(5731);function m(e){return e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""}function v(e){if(!e)return"";let t=String(e);return t=(t=(t=(t=(t=(t=(t=(t=(t=(t=t.replace(/```([\s\S]*?)```/g,(e,t)=>"<pre><code>".concat(m(t),"</code></pre>"))).replace(/`([^`]+)`/g,(e,t)=>"<code>".concat(m(t),"</code>"))).replace(/^###\s?(.*)$/gm,"<h3>$1</h3>")).replace(/^##\s?(.*)$/gm,"<h2>$1</h2>")).replace(/^#\s?(.*)$/gm,"<h1>$1</h1>")).replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>")).replace(/\*(.*?)\*/g,"<em>$1</em>")).replace(/(^|-\n)((?:[ \t]*[-\*]\s.*\n?)+)/g,(e,t,a)=>{let n=a.split(/\n/).filter(Boolean).map(e=>e.replace(/^[ \t]*[-\*]\s*/,""));return"<ul>".concat(n.map(e=>"<li>".concat(e,"</li>")).join(""),"</ul>")})).replace(/\n{2,}/g,"</p><p>")).replace(/\n/g,"<br />"),/^\s*<\/(?:p|h1|h2|h3|ul|pre)>/.test(t)||(t="<p>".concat(t,"</p>")),t}function _(e){let{isOpen:t,onClose:a,onOpenAnalysisFavoriteModal:o,onOpenAnalysisFullFavoriteModal:s,styles:r,topicIndex:i}=e,[c,u]=(0,l.useState)(""),[m,_]=(0,l.useState)(null),[f,p]=(0,l.useState)({}),[y,g]=(0,l.useState)(!1),h=()=>(null==m?void 0:m.id)&&f[m.id]||[],w=e=>{(null==m?void 0:m.id)&&p(t=>({...t,[m.id]:e}))};(0,l.useEffect)(()=>{if(!t||null==i)return;let e=sessionStorage.getItem("quizData");if(!e)return;let a=JSON.parse(e);Array.isArray(a.topics)&&a.topics[i]&&(_(a.topics[i]),u(""))},[t,i]);let b=async()=>{let e=c.trim();if(!e||y)return;let t=[...h(),{role:"user",content:e}];w(t),u(""),g(!0);try{var a,n,l,o,s,r,i;let c="".concat(d.Py,"/api/chat/"),u=localStorage.getItem("token"),v=JSON.parse(sessionStorage.getItem("quizData")||"{}").quiz.user.username,_=await fetch(c,{method:"POST",headers:{"Content-Type":"application/json",...u?{Authorization:"Bearer ".concat(u)}:{}},body:JSON.stringify({user_id:localStorage.getItem("userId")||null,sender:v,message:e,topic_id:null!=(l=null==m?void 0:m.id)?l:null})}),f=await _.json(),p=null!=(i=null!=(r=null!=(s=null!=(o=null==f||null==(a=f.ai_response)?void 0:a.content)?o:null==f||null==(n=f["ai-response"])?void 0:n.content)?s:null==f?void 0:f.content)?r:null==f?void 0:f.reply)?i:"（沒有收到 AI 內容）",y=[...t,{role:"ai",content:p}];w(y)}catch(e){console.error("AI 對話錯誤：",e),w([...t,{role:"ai",content:"抱歉，伺服器忙碌或發生錯誤，稍後再試。"}])}finally{g(!1)}};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"".concat(r["overlay-backdrop"]," ").concat(t?r.active:""),onClick:a}),(0,n.jsxs)("div",{className:"".concat(r["analysis-overlay"]," ").concat(t?r.active:""),children:[(0,n.jsxs)("div",{className:r["analysis-header"],children:[(0,n.jsx)("h2",{className:r["analysis-title"],children:"解析"}),(0,n.jsx)("button",{className:r["close-btn"],onClick:a,children:"\xd7"})]}),(0,n.jsx)("div",{className:r["analysis-content"],children:(0,n.jsxs)("div",{className:r["chat-messages"],children:[(0,n.jsx)("div",{className:"".concat(r.message," ").concat(r.ai),children:(0,n.jsx)("div",{dangerouslySetInnerHTML:{__html:v((null==m?void 0:m.explanation_text)||"正在載入解析...")}})}),(0,n.jsxs)("div",{className:"".concat(r.message," ").concat(r.ai),children:["對於題目："+((null==m?void 0:m.title)||"")+"還有什麼問題嗎？"," "]}),(()=>{let e=h();return 0===e.length?(0,n.jsx)(n.Fragment,{}):(0,n.jsxs)(n.Fragment,{children:[e.map((e,t)=>(0,n.jsxs)("div",{className:"".concat(r.message," ").concat("user"===e.role?r.user:r.ai),children:["ai"===e.role&&(0,n.jsx)("div",{className:r["placeholder-icon"],onClick:()=>{var t;return t=e.content,void(window.__analysisSelectedContent={content:t||"",title:"解析內容收藏 - ".concat(new Date().toLocaleDateString("zh-TW"))},o())},children:"+"}),"ai"===e.role?(0,n.jsx)("div",{dangerouslySetInnerHTML:{__html:v(e.content||"")}}):(0,n.jsx)("span",{children:e.content})]},t)),y&&(0,n.jsx)("div",{className:"".concat(r.message," ").concat(r.placeholder),children:"正在思考中…"})]})})()]})}),(0,n.jsxs)("div",{className:r["analysis-input"],children:[(0,n.jsx)("span",{className:r["add-icon"],onClick:()=>{let e=(()=>{let e=[];e.push("# 完整對話記錄"),(null==m?void 0:m.explanation_text)&&(e.push(""),e.push(m.explanation_text)),e.push(""),e.push("對於題目:".concat((null==m?void 0:m.title)||"","還有什麼問題嗎?"));let t=h();return t.length>0?(e.push(""),t.forEach(t=>{let a="user"===t.role?"你":"AI";e.push("### ".concat(a,"：")),e.push(t.content||""),e.push("")})):(e.push(""),e.push("你的問題會在這裡"),e.push(""),e.push("AI的回答在這裡")),e.join("\n")})(),t="完整對話收藏 - ".concat(new Date().toLocaleDateString("zh-TW"));window.__analysisFullContent={content:e,title:t},s()},children:"+"}),(0,n.jsx)("input",{type:"text",className:r["input-field"],placeholder:"輸入問題",value:c,onChange:e=>u(e.target.value),onKeyPress:e=>{"Enter"===e.key&&b()}}),(0,n.jsx)("button",{className:r["send-btn"],onClick:b,children:(0,n.jsx)("span",{children:"→"})})]})]})]})}var f=a(3424);let p={openType:null,closeCallbacks:new Set};function y(e){let{subjects:t,currentSubject:a,onSubjectChange:o,onShowCustomPrompt:s,onShowCustomAlert:r,styles:c,type:u="favorite"}=e,[d,m]=(0,l.useState)(!1),v=(0,l.useCallback)(e=>"analysis-favorite"===u?c["analysis-favorite-".concat(e)]:"analysis-full-favorite"===u?c["analysis-full-favorite-".concat(e)]:c["favorite-".concat(e)],[u,c]);return(0,l.useEffect)(()=>{let e=()=>{d&&m(!1)};p.closeCallbacks.add(e);let t=e=>{!e.target.closest(".".concat(v("custom-select-container")))&&d&&(m(!1),p.openType=null)};return document.addEventListener("click",t),()=>{p.closeCallbacks.delete(e),document.removeEventListener("click",t)}},[d,v]),(0,n.jsxs)("div",{className:v("subject-selector"),children:[(0,n.jsx)("label",{className:v("filter-label"),children:"選擇主題"}),(0,n.jsx)("div",{className:v("select-wrapper"),children:(0,n.jsxs)("div",{className:v("custom-select-container"),children:[(0,n.jsxs)("div",{className:v("custom-select"),onClick:()=>{d?(m(!1),p.openType=null):(p.closeCallbacks.forEach(e=>{e!==(()=>m(!1))&&e()}),m(!0),p.openType="subject")},children:[(0,n.jsx)("span",{children:a}),(0,n.jsx)(i.default,{src:"/img/Vector-17.png",className:v("select-arrow"),width:16,height:16,alt:""})]}),(0,n.jsxs)("div",{className:"".concat(v("custom-dropdown")," ").concat(d?c.active:""),children:[t.map(e=>(0,n.jsx)("button",{className:"".concat(v("dropdown-option")," ").concat(e===a?c.selected:""),onClick:()=>{o(e),m(!1),p.openType=null},children:(0,n.jsx)("span",{className:v("option-text"),children:e})},e)),(0,n.jsx)("div",{style:{height:"1px",backgroundColor:"#eee",margin:"8px 16px"}}),(0,n.jsx)("button",{className:v("dropdown-option"),onClick:()=>{s("請輸入新主題名稱：",async e=>{if(e&&e.trim()){let a=e.trim();if(t.includes(a))return void r("主題已存在！");o(a),r("主題「".concat(a,"」新增成功！"));try{let e=await (0,f.oX)(a);e.success||console.warn("主題同步失敗:",e.message)}catch(e){console.warn("主題同步失敗:",e)}}}),m(!1),p.openType=null},children:(0,n.jsx)("span",{className:v("option-text"),children:"新增主題"})})]})]})})]})}let g={openType:null,closeCallbacks:new Set};function h(e){let{notes:t,currentNoteId:a,onNoteChange:o,styles:s,type:r="favorite",currentSubject:c=""}=e,[u,d]=(0,l.useState)(!1),[m,v]=(0,l.useState)("新增筆記"),[_,f]=(0,l.useState)([]),p=(0,l.useCallback)(e=>"analysis-favorite"===r?s["analysis-favorite-".concat(e)]:"analysis-full-favorite"===r?s["analysis-full-favorite-".concat(e)]:s["favorite-".concat(e)],[r,s]);(0,l.useEffect)(()=>{let e=()=>{u&&d(!1)};g.closeCallbacks.add(e);let t=e=>{!e.target.closest(".".concat(p("note-select-container")))&&u&&(d(!1),g.openType=null)};return document.addEventListener("click",t),()=>{g.closeCallbacks.delete(e),document.removeEventListener("click",t)}},[u,p]),(0,l.useEffect)(()=>{(async()=>{if(c)try{let e=Array.isArray(t)?t.filter(e=>e.subject===c):[];f(e)}catch(e){f([])}else f([])})()},[c,t]),(0,l.useEffect)(()=>{Array.isArray(_)&&_.length>0&&null===a?o(_[0].id):Array.isArray(_)&&0!==_.length||o("add_note")},[_,a,o]),(0,l.useEffect)(()=>{if("add_note"===a)v("新增筆記");else{let e=Array.isArray(_)?_.find(e=>e.id===a):null;e?v(e.title.length>20?e.title.substring(0,20)+"...":e.title):v("新增筆記")}},[a,_]);let y=e=>{o(e),d(!1),g.openType=null};return(0,n.jsxs)("div",{className:p("note-selector"),children:[(0,n.jsx)("label",{className:p("filter-label"),children:"選擇筆記"}),(0,n.jsx)("div",{className:p("note-select-wrapper"),children:(0,n.jsxs)("div",{className:p("note-select-container"),children:[(0,n.jsxs)("div",{className:p("note-select"),onClick:()=>{u?(d(!1),g.openType=null):(g.closeCallbacks.forEach(e=>{e!==(()=>d(!1))&&e()}),d(!0),g.openType="note")},children:[(0,n.jsx)("span",{children:m}),(0,n.jsx)(i.default,{src:"/img/Vector-17.png",className:p("note-select-arrow"),width:16,height:16,alt:""})]}),(0,n.jsxs)("div",{className:"".concat(p("note-dropdown")," ").concat(u?s.active:""),children:[Array.isArray(_)&&_.length>0?_.map(e=>(0,n.jsx)("button",{className:"".concat(p("note-dropdown-option")," ").concat(e.id===a?s.selected:""),onClick:()=>y(e.id),children:(0,n.jsx)("span",{className:p("note-option-text"),children:e.title.length>20?e.title.substring(0,20)+"...":e.title})},e.id)):(0,n.jsx)("div",{style:{padding:"14px 18px",color:"#999",textAlign:"center"},children:"該主題下暫無筆記"}),(0,n.jsx)("div",{style:{height:"1px",backgroundColor:"#eee",margin:"8px 16px"}}),(0,n.jsx)("button",{className:"".concat(p("note-dropdown-option")," ").concat("add_note"===a?s.selected:""),onClick:()=>y("add_note"),children:(0,n.jsx)("span",{className:p("note-option-text"),children:"新增筆記"})})]})]})})]})}function w(e){let{content:t,onChange:a,isPreviewMode:o,onTogglePreview:s,styles:r}=e,i=(0,l.useRef)(null);return(0,l.useEffect)(()=>{o&&t&&setTimeout(()=>{if(i.current){let e=t.replace(/^### (.*$)/gim,"<h3>$1</h3>").replace(/^## (.*$)/gim,"<h2>$1</h2>").replace(/^# (.*$)/gim,"<h1>$1</h1>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`(.*?)`/g,"<code>$1</code>").replace(/^- (.*$)/gim,"<li>$1</li>").replace(/^---$/gim,"<hr>").replace(/\n/g,"<br>");i.current.innerHTML=e}},0)},[t,o]),(0,n.jsxs)("div",{className:r["content-editor"],children:[(0,n.jsx)("button",{className:r["content-toggle"],onClick:s,children:o?"編輯":"完成"}),(0,n.jsx)("textarea",{className:r["content-textarea"],placeholder:"請輸入或編輯內容...",value:t,onChange:e=>a(e.target.value),style:{display:o?"none":"block"}}),(0,n.jsx)("div",{ref:i,className:"".concat(r["content-preview"]," ").concat(o?r.active:""),style:{display:o?"block":"none"}})]})}function b(e){let{isOpen:t,onClose:a,questionData:o,subjects:s,notes:r,onShowCustomAlert:i,onShowCustomPrompt:c,styles:u}=e,[m,v]=(0,l.useState)("新增主題"),[_,f]=(0,l.useState)(null),[p,g]=(0,l.useState)(""),[b,x]=(0,l.useState)(""),[j,O]=(0,l.useState)(!0);(0,l.useEffect)(()=>{if(t&&o){var e,a,n,l,s;let t=null!=(a=o.options)?a:{A:o.option_A,B:o.option_B,C:o.option_C,D:o.option_D},r=null!=(l=null!=(n=o.correctAnswer)?n:o.aiAnswer)?l:"",i=null!=(s=t[r])?s:r,c=JSON.parse(sessionStorage.getItem("quizData")||"{}"),u="";if((null==c?void 0:c.topics)&&Array.isArray(c.topics)){let e=c.topics.find(e=>e.id===o.id);u=(null==e?void 0:e.explanation_text)||""}let d="## 題目解析\n".concat(u,"\n\n**正確答案：** ").concat(i),m=(null==c||null==(e=c.quiz)?void 0:e.quiz_topic)||"題目收藏",_=o.title||"收藏題目 - 第".concat(o.number,"題");x(d),g(_),v(m),f(null)}},[t,o]);let P=async()=>{var e,t,a;let n=localStorage.getItem("userId"),l=localStorage.getItem("token");if(!n)throw Error("找不到 userId，請確認已登入。");if(!l)throw Error("找不到 token，請確認已登入。");let s=JSON.parse(sessionStorage.getItem("quizData")||"{}"),r=null!=(e=o.options)?e:{A:o.option_A,B:o.option_B,C:o.option_C,D:o.option_D},i=o.userSelected?null!=(t=r[o.userSelected])?t:o.userSelected:"",c=o.aiAnswer?null!=(a=r[o.aiAnswer])?a:o.aiAnswer:"",u="";if((null==s?void 0:s.topics)&&Array.isArray(s.topics)){let e=s.topics.find(e=>e.id===o.id);u=(null==e?void 0:e.explanation_text)||""}let v=null;try{let e=await fetch("".concat(d.Py,"/api/user_quiz_and_notes/"),{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(l)}});if(e.ok){let t=await e.json(),a=(Array.isArray(null==t?void 0:t.favorite_quiz_topics)?t.favorite_quiz_topics:[]).find(e=>(null==e?void 0:e.quiz_topic)===m);a&&(v=a.id)}}catch(e){}if(!v)try{if(!m||""===m.trim())throw Error("主題名稱不能為空");let e=await fetch("".concat(d.Py,"/api/create_quiz/"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(l)},body:JSON.stringify({quiz_topic:m.trim()})});if(e.ok){let t=await e.json();if(!(v=t.quiz_topic_id||t.id))throw Error("創建主題成功但返回的ID無效")}else{let t=await e.text();throw Error("創建主題失敗: ".concat(e.status," - ").concat(t))}}catch(e){console.warn("創建主題失敗:",e.message),v=1}if(!v)throw Error("無法獲取或創建主題ID");let _={user_id:Number(n),topic_id:Number(v),title:o.title||"收藏題目 - 第".concat(o.number,"題"),content:{explanation_text:u||"",user_answer:i||"",Ai_answer:c||""}},f=await fetch("".concat(d.Py,"/api/add-favorite/"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(l)},body:JSON.stringify(_)});if(!f.ok)throw Error(await f.text()||"收藏失敗 (".concat(f.status,")"));return await f.json().catch(()=>({}))},N=async()=>{if(!o)return void i("沒有要收藏的題目數據！");try{if(i("題目已收藏到「".concat(m,"」主題！")),a(),"add_note"===_||null===_){let e=p.trim()||"收藏題目 - 第".concat(o.number,"題"),t={id:Date.now(),title:e,content:b,subject:m};window.addNoteToSystem&&window.addNoteToSystem(t).catch(()=>{})}else{let e=Array.isArray(A)?A.find(e=>e.id===_):null;if(e){let t=e.content||"",a="".concat(t,"\n---\n## 新增題目\n").concat(b),n={...e,content:a};try{let e=localStorage.getItem("token");fetch("".concat(d.Py,"/api/notes/").concat(_,"/"),{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:e?"Bearer ".concat(e):""},body:JSON.stringify({title:n.title,content:n.content})}).catch(()=>{})}catch(e){}}}try{await P()}catch(e){}}catch(e){}},A=Array.isArray(r)?r.filter(e=>e.subject===m):[];return(0,n.jsx)("div",{className:"".concat(u["favorite-modal"]," ").concat(t?u.active:""),children:(0,n.jsxs)("div",{className:u["favorite-modal-content"],children:[(0,n.jsxs)("div",{className:u["favorite-modal-header"],children:[(0,n.jsx)("h2",{className:u["favorite-modal-title"],children:"收藏題目"}),(0,n.jsx)("button",{className:u["favorite-modal-close"],onClick:a,children:"\xd7"})]}),(0,n.jsxs)("div",{className:u["favorite-modal-body"],children:[(0,n.jsxs)("div",{className:u["favorite-question-info"],children:[(0,n.jsx)("h3",{children:"題目內容"}),(0,n.jsx)(w,{content:b,onChange:x,isPreviewMode:j,onTogglePreview:()=>O(!j),styles:u})]}),(0,n.jsx)(y,{subjects:s,currentSubject:m,onSubjectChange:v,onShowCustomPrompt:c,onShowCustomAlert:i,styles:u}),(0,n.jsx)(h,{notes:A,currentNoteId:_,onNoteChange:f,styles:u,currentSubject:m}),("add_note"===_||null===_)&&(0,n.jsxs)("div",{className:u["favorite-note-title-input"],children:[(0,n.jsx)("label",{htmlFor:"favorite-note-title",className:u["favorite-filter-label"],children:"筆記標題"}),(0,n.jsx)("input",{type:"text",id:"favorite-note-title",className:u["favorite-note-title-field"],placeholder:"請輸入筆記標題...",value:p,onChange:e=>g(e.target.value)})]})]}),(0,n.jsxs)("div",{className:u["favorite-modal-footer"],children:[(0,n.jsx)("button",{className:"".concat(u["favorite-modal-btn"]," ").concat(u["favorite-modal-btn-secondary"]),onClick:a,children:"取消"}),(0,n.jsx)("button",{className:"".concat(u["favorite-modal-btn"]," ").concat(u["favorite-modal-btn-primary"]),onClick:N,children:"收藏"})]})]})})}function x(e){let{isOpen:t,onClose:a,subjects:o,notes:s,onShowCustomAlert:r,onShowCustomPrompt:i,styles:c}=e,[u,m]=(0,l.useState)("數學"),[v,_]=(0,l.useState)(null),[f,p]=(0,l.useState)(""),[g,b]=(0,l.useState)(""),[x,j]=(0,l.useState)(!0),[O,P]=(0,l.useState)(null),[N,A]=(0,l.useState)(null),[S,G]=(0,l.useState)(!1);(0,l.useEffect)(()=>{if(t){var e;let t="AI的回答在這裡";(null==(e=window.__analysisSelectedContent)?void 0:e.content)&&(t=window.__analysisSelectedContent.content,delete window.__analysisSelectedContent),b("## ".concat(t)),p("解析內容收藏 - ".concat(new Date().toLocaleDateString("zh-TW"))),m("數學"),_(null);let{subject:a,noteId:n,title:l}=function(){try{var e,t,a,n,l,o,s,r,i,c,u,d;let m=window.sessionStorage.getItem("quizData");if(!m)return{subject:null,noteId:null,title:null};let v=JSON.parse(m),_=null!=(i=null!=(r=null!=(s=null==v||null==(e=v.quiz)?void 0:e.quiz_topic)?s:Array.isArray(null==v?void 0:v.quizzes)&&(null==(t=v.quizzes[0])?void 0:t.quiz_topic))?r:Array.isArray(null==v?void 0:v.topics)&&(null==(a=v.topics[0])?void 0:a.subject))?i:null,f=null!=(c=Array.isArray(null==v?void 0:v.notes)&&(null==(n=v.notes[0])?void 0:n.id))?c:null,p=null!=(d=null!=(u=Array.isArray(null==v?void 0:v.notes)&&(null==(l=v.notes[0])?void 0:l.title))?u:Array.isArray(null==v?void 0:v.topics)&&(null==(o=v.topics[0])?void 0:o.title))?d:null;return{subject:_,noteId:f,title:p}}catch(e){return{subject:null,noteId:null,title:null}}}();a&&m(a),null!=n&&_(n),l&&p(l)}},[t]),(0,l.useEffect)(()=>{t&&(async()=>{try{var e,t;G(!0);let a=localStorage.getItem("token"),n=await fetch("".concat(d.Py,"/api/user_quiz_and_notes/"),{method:"GET",headers:{"Content-Type":"application/json",...a?{Authorization:"Bearer ".concat(a)}:{}}}),l=await n.json(),o=(null==l?void 0:l.favorite_quiz_topics)&&Array.isArray(l.favorite_quiz_topics)?l.favorite_quiz_topics.map(e=>null==e?void 0:e.quiz_topic).filter(Boolean):(null!=(t=null!=(e=null==l?void 0:l.subjects)?e:null==l?void 0:l.quizzes)?t:[]).map(e=>{var t,a,n;return"string"==typeof e?e:null!=(n=null!=(a=null!=(t=e.name)?t:e.quiz_topic)?a:e.title)?n:"未分類"}),s=function(e){var t;if((null==e?void 0:e.favorite_notes)&&Array.isArray(e.favorite_notes)){let t=new Map((Array.isArray(null==e?void 0:e.favorite_quiz_topics)?e.favorite_quiz_topics:[]).map(e=>[Number(null==e?void 0:e.id),String((null==e?void 0:e.quiz_topic)||"").trim()]));return e.favorite_notes.map(e=>{var a;let n=null!=(a=null==e?void 0:e.title)?a:"",l=String((null==e?void 0:e.content)||"").split("\n")[0],o=String(n).trim()||l||"未命名筆記",s="";if("string"==typeof(null==e?void 0:e.content))try{s=JSON.parse(e.content.replace(/'/g,'"')).explanation_text||e.content}catch(t){s=e.content}else"object"==typeof(null==e?void 0:e.content)&&(null==e?void 0:e.content)!==null&&(s=e.content.explanation_text||"");let r=null==e?void 0:e.quiz_topic_id,i=t.get(Number(r))||"";return{id:Number(null==e?void 0:e.id),title:o,content:s,subject:i}})}return(null!=(t=null==e?void 0:e.notes)?t:[]).map(e=>{var t,a,n,l,o,s;return{id:e.id,title:null!=(a=null!=(t=e.title)?t:e.name)?a:"未命名筆記 ".concat(e.id),content:e.content||"",subject:null!=(s=null!=(o=null!=(l=null!=(n=e.subject)?n:e.subject_name)?l:e.topic)?o:e.quiz_topic)?s:"未分類"}})}(l);P(o),A(s),o.length>0&&!o.includes(u)&&m(o[0])}catch(e){console.error("取得主題/筆記選項失敗：",e),P(null),A(null)}finally{G(!1)}})()},[t]);let C=async()=>{if(!g.trim())return void r("沒有要收藏的內容！");try{if("add_note"===v||null===v)r("內容已收藏到「".concat(u,"」主題！"));else{let e=Array.isArray(k)?k.find(e=>e.id===v):null;e&&r("內容已添加到筆記「".concat(e.title,"」中！"))}if(a(),"add_note"===v||null===v){let e=f.trim()||"解析內容收藏 - ".concat(new Date().toLocaleDateString("zh-TW")),t={id:Date.now(),title:e,content:g,subject:u};window.addNoteToSystem&&window.addNoteToSystem(t).catch(()=>{})}else{let e=Array.isArray(k)?k.find(e=>e.id===v):null;if(e){let t=e.content||"",a="".concat(t,"\n\n---\n\n## 新增內容\n\n").concat(g),n={...e,content:a};try{let e=localStorage.getItem("token");fetch("".concat(d.Py,"/api/notes/").concat(v,"/"),{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:e?"Bearer ".concat(e):""},body:JSON.stringify({title:n.title,content:n.content})}).catch(()=>{})}catch(e){}}}}catch(e){}},k=null!=N?N:s,q=Array.isArray(k)?k.filter(e=>e.subject===u):[];return(0,n.jsx)("div",{className:"".concat(c["analysis-favorite-modal"]," ").concat(t?c.active:""),children:(0,n.jsxs)("div",{className:c["analysis-favorite-modal-content"],children:[(0,n.jsxs)("div",{className:c["analysis-favorite-modal-header"],children:[(0,n.jsx)("h2",{className:c["analysis-favorite-modal-title"],children:"收藏對話內容"}),(0,n.jsx)("button",{className:c["analysis-favorite-modal-close"],onClick:a,children:"\xd7"})]}),(0,n.jsxs)("div",{className:c["analysis-favorite-modal-body"],children:[(0,n.jsxs)("div",{className:c["analysis-favorite-content-info"],children:[(0,n.jsx)("h3",{children:"收藏內容"}),(0,n.jsx)(w,{content:g,onChange:b,isPreviewMode:x,onTogglePreview:()=>j(!x),styles:c})]}),(0,n.jsx)(y,{subjects:null!=O?O:o,currentSubject:u,onSubjectChange:m,onShowCustomPrompt:i,onShowCustomAlert:r,styles:c,type:"analysis-favorite"}),(0,n.jsx)(h,{notes:q,currentNoteId:v,onNoteChange:_,styles:c,type:"analysis-favorite",currentSubject:u}),("add_note"===v||null===v)&&(0,n.jsxs)("div",{className:c["analysis-favorite-note-title-input"],children:[(0,n.jsx)("label",{className:c["analysis-favorite-filter-label"],children:"筆記標題"}),(0,n.jsx)("input",{type:"text",className:c["analysis-favorite-note-title-field"],placeholder:"請輸入筆記標題...",value:f,onChange:e=>p(e.target.value)})]})]}),(0,n.jsxs)("div",{className:c["analysis-favorite-modal-footer"],children:[(0,n.jsx)("button",{className:"".concat(c["analysis-favorite-modal-btn"]," ").concat(c["analysis-favorite-modal-btn-secondary"]),onClick:a,children:"取消"}),(0,n.jsx)("button",{className:"".concat(c["analysis-favorite-modal-btn"]," ").concat(c["analysis-favorite-modal-btn-primary"]),onClick:C,children:"收藏"})]})]})})}function j(e){let{isOpen:t,onClose:a,subjects:o,notes:s,onShowCustomAlert:r,onShowCustomPrompt:i,styles:c}=e,[u,m]=(0,l.useState)("數學"),[v,_]=(0,l.useState)(null),[f,p]=(0,l.useState)(""),[g,b]=(0,l.useState)(""),[x,j]=(0,l.useState)(!0),[O,P]=(0,l.useState)(null),[N,A]=(0,l.useState)(null),[S,G]=(0,l.useState)(!1);(0,l.useEffect)(()=>{if(t){var e,a;let t=window.__analysisFullContent;b(null!=(e=null==t?void 0:t.content)?e:"# 完整對話記錄\n\n## 你打的問題會在這裡\n\n## AI的回答在這裡"),p(null!=(a=null==t?void 0:t.title)?a:"完整對話收藏 - ".concat(new Date().toLocaleDateString("zh-TW"))),m("數學"),_(null),window.__analysisFullContent=null;let{subject:n,noteId:l,title:o}=function(){try{var e,t,a,n,l,o,s,r,i,c,u,d;let m=window.sessionStorage.getItem("quizData");if(!m)return{subject:null,noteId:null,title:null};let v=JSON.parse(m),_=null!=(i=null!=(r=null!=(s=null==v||null==(e=v.quiz)?void 0:e.quiz_topic)?s:Array.isArray(null==v?void 0:v.quizzes)&&(null==(t=v.quizzes[0])?void 0:t.quiz_topic))?r:Array.isArray(null==v?void 0:v.topics)&&(null==(a=v.topics[0])?void 0:a.subject))?i:null,f=null!=(c=Array.isArray(null==v?void 0:v.notes)&&(null==(n=v.notes[0])?void 0:n.id))?c:null,p=null!=(d=null!=(u=Array.isArray(null==v?void 0:v.notes)&&(null==(l=v.notes[0])?void 0:l.title))?u:Array.isArray(null==v?void 0:v.topics)&&(null==(o=v.topics[0])?void 0:o.title))?d:null;return{subject:_,noteId:f,title:p}}catch(e){return{subject:null,noteId:null,title:null}}}();n&&m(n),null!=l&&_(l),o&&p(o)}},[t]),(0,l.useEffect)(()=>{t&&(async()=>{try{var e,t;G(!0);let a=localStorage.getItem("token"),n=await fetch("".concat(d.Py,"/api/user_quiz_and_notes/"),{method:"GET",headers:{"Content-Type":"application/json",...a?{Authorization:"Bearer ".concat(a)}:{}}}),l=await n.json(),o=(null==l?void 0:l.favorite_quiz_topics)&&Array.isArray(l.favorite_quiz_topics)?l.favorite_quiz_topics.map(e=>null==e?void 0:e.quiz_topic).filter(Boolean):(null!=(t=null!=(e=null==l?void 0:l.subjects)?e:null==l?void 0:l.quizzes)?t:[]).map(e=>{var t,a,n;return"string"==typeof e?e:null!=(n=null!=(a=null!=(t=e.name)?t:e.quiz_topic)?a:e.title)?n:"未分類"}),s=function(e){var t;if((null==e?void 0:e.favorite_notes)&&Array.isArray(e.favorite_notes)){let t=new Map((Array.isArray(null==e?void 0:e.favorite_quiz_topics)?e.favorite_quiz_topics:[]).map(e=>[Number(null==e?void 0:e.id),String((null==e?void 0:e.quiz_topic)||"").trim()]));return e.favorite_notes.map(e=>{var a;let n=null!=(a=null==e?void 0:e.title)?a:"",l=String((null==e?void 0:e.content)||"").split("\n")[0],o=String(n).trim()||l||"未命名筆記",s="";if("string"==typeof(null==e?void 0:e.content))try{s=JSON.parse(e.content.replace(/'/g,'"')).explanation_text||e.content}catch(t){s=e.content}else"object"==typeof(null==e?void 0:e.content)&&(null==e?void 0:e.content)!==null&&(s=e.content.explanation_text||"");let r=null==e?void 0:e.quiz_topic_id,i=t.get(Number(r))||"";return{id:Number(null==e?void 0:e.id),title:o,content:s,subject:i}})}return(null!=(t=null==e?void 0:e.notes)?t:[]).map(e=>{var t,a,n,l,o,s;return{id:e.id,title:null!=(a=null!=(t=e.title)?t:e.name)?a:"未命名筆記 ".concat(e.id),content:e.content||"",subject:null!=(s=null!=(o=null!=(l=null!=(n=e.subject)?n:e.subject_name)?l:e.topic)?o:e.quiz_topic)?s:"未分類"}})}(l);P(o),A(s),o.length>0&&!o.includes(u)&&m(o[0])}catch(e){console.error("取得主題/筆記選項失敗：",e),P(null),A(null)}finally{G(!1)}})()},[t]);let C=async()=>{if(!g.trim())return void r("沒有要收藏的對話內容！");try{if("add_note"===v||null===v)r("完整對話已收藏到「".concat(u,"」主題！"));else{let e=Array.isArray(k)?k.find(e=>e.id===v):null;e&&r("完整對話已添加到筆記「".concat(e.title,"」中！"))}if(a(),"add_note"===v||null===v){let e=f.trim()||"完整對話收藏 - ".concat(new Date().toLocaleDateString("zh-TW")),t={id:Date.now(),title:e,content:g,subject:u};window.addNoteToSystem&&window.addNoteToSystem(t).catch(()=>{})}else{let e=Array.isArray(k)?k.find(e=>e.id===v):null;if(e){let t=e.content||"",a="".concat(t,"\n\n---\n\n## 新增完整對話\n\n").concat(g),n={...e,content:a};try{let e=localStorage.getItem("token");fetch("".concat(d.Py,"/api/notes/").concat(v,"/"),{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:e?"Bearer ".concat(e):""},body:JSON.stringify({title:n.title,content:n.content})}).catch(()=>{})}catch(e){}}}}catch(e){}},k=null!=N?N:s,q=Array.isArray(k)?k.filter(e=>e.subject===u):[];return(0,n.jsx)("div",{className:"".concat(c["analysis-full-favorite-modal"]," ").concat(t?c.active:""),children:(0,n.jsxs)("div",{className:c["analysis-full-favorite-modal-content"],children:[(0,n.jsxs)("div",{className:c["analysis-full-favorite-modal-header"],children:[(0,n.jsx)("h2",{className:c["analysis-full-favorite-modal-title"],children:"收藏完整對話"}),(0,n.jsx)("button",{className:c["analysis-full-favorite-modal-close"],onClick:a,children:"\xd7"})]}),(0,n.jsxs)("div",{className:c["analysis-full-favorite-modal-body"],children:[(0,n.jsxs)("div",{className:c["analysis-full-favorite-content-info"],children:[(0,n.jsx)("h3",{children:"收藏內容"}),(0,n.jsx)(w,{content:g,onChange:b,isPreviewMode:x,onTogglePreview:()=>j(!x),styles:c})]}),(0,n.jsx)(y,{subjects:null!=O?O:o,currentSubject:u,onSubjectChange:m,onShowCustomPrompt:i,onShowCustomAlert:r,styles:c,type:"analysis-full-favorite"}),(0,n.jsx)(h,{notes:q,currentNoteId:v,onNoteChange:_,styles:c,type:"analysis-full-favorite",currentSubject:u}),("add_note"===v||null===v)&&(0,n.jsxs)("div",{className:c["analysis-full-favorite-note-title-input"],children:[(0,n.jsx)("label",{className:c["analysis-full-favorite-filter-label"],children:"筆記標題"}),(0,n.jsx)("input",{type:"text",className:c["analysis-full-favorite-note-title-field"],placeholder:"請輸入筆記標題...",value:f,onChange:e=>p(e.target.value)})]})]}),(0,n.jsxs)("div",{className:c["analysis-full-favorite-modal-footer"],children:[(0,n.jsx)("button",{className:"".concat(c["analysis-full-favorite-modal-btn"]," ").concat(c["analysis-full-favorite-modal-btn-secondary"]),onClick:a,children:"取消"}),(0,n.jsx)("button",{className:"".concat(c["analysis-full-favorite-modal-btn"]," ").concat(c["analysis-full-favorite-modal-btn-primary"]),onClick:C,children:"收藏"})]})]})})}function O(e){let{isOpen:t,message:a,onClose:l,styles:o}=e;return(0,n.jsx)("div",{className:"".concat(o["custom-alert-modal"]," ").concat(t?o.active:""),children:(0,n.jsxs)("div",{className:o["custom-alert-content"],children:[(0,n.jsx)("div",{className:o["custom-alert-message"],children:a}),(0,n.jsx)("button",{className:o["custom-alert-btn"],onClick:l,children:"確定"})]})})}function P(e){let{isOpen:t,title:a,onClose:o,onConfirm:s,styles:r}=e,[i,c]=(0,l.useState)("");(0,l.useEffect)(()=>{t&&c("")},[t]);let u=()=>{s(i.trim())};return(0,n.jsx)("div",{className:"".concat(r["custom-prompt-modal"]," ").concat(t?r.active:""),children:(0,n.jsxs)("div",{className:r["custom-prompt-content"],children:[(0,n.jsx)("div",{className:r["custom-prompt-title"],children:a}),(0,n.jsx)("input",{type:"text",className:r["custom-prompt-input"],placeholder:"請輸入...",value:i,onChange:e=>c(e.target.value),onKeyPress:e=>{"Enter"===e.key&&u()},autoFocus:!0}),(0,n.jsxs)("div",{className:r["custom-prompt-buttons"],children:[(0,n.jsx)("button",{className:"".concat(r["custom-prompt-btn"]," ").concat(r["custom-prompt-btn-secondary"]),onClick:o,children:"取消"}),(0,n.jsx)("button",{className:"".concat(r["custom-prompt-btn"]," ").concat(r["custom-prompt-btn-primary"]),onClick:u,children:"確定"})]})]})})}var N=a(7075),A=a.n(N),S=a(6349);function G(){let[e,t]=(0,l.useState)(!1),[a,i]=(0,l.useState)(!1),[c,d]=(0,l.useState)(!1),[m,v]=(0,l.useState)(!1),[p,y]=(0,l.useState)(!1),[g,h]=(0,l.useState)(!1),[w,N]=(0,l.useState)(!1),[G,C]=(0,l.useState)(""),[k,q]=(0,l.useState)(""),[z,T]=(0,l.useState)(null),[I,E]=(0,l.useState)(null),[D,L]=(0,l.useState)(null),[M,$]=(0,l.useState)([]),[B,F]=(0,l.useState)([]),[J,V]=(0,l.useState)({total:0,correct:0,wrong:0,accuracy:0}),{questionData:W,subjects:K,notes:H,isPlusSubscribed:X,checkPlusSubscription:U,showUpgradeAlert:Y,addNoteToSystem:Z,showCustomAlert:Q,showCustomPrompt:R,parseMarkdown:ee,updateContentPreview:et}=function(){let[e,t]=(0,l.useState)(!1),[a,n]=(0,l.useState)([]),[o,s]=(0,l.useState)([]),[r,i]=(0,l.useState)(!1),[c,u]=(0,l.useState)(0);(0,l.useCallback)(async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3;for(let n=0;n<t;n++)try{return await e()}catch(e){if(n===t-1)throw e;await new Promise(e=>setTimeout(e,a*(n+1)))}},[]);let d=(0,l.useCallback)((e,t)=>{if(!e)return!1;switch(t){case"subjects":return Array.isArray(e)&&e.every(e=>"string"==typeof e);case"notes":return Array.isArray(e)&&e.every(e=>e&&"object"==typeof e&&"number"==typeof e.id&&"string"==typeof e.title);default:return!0}},[]),m=(0,l.useCallback)(async()=>{try{let e=Date.now();if(r&&e-c<3e4)return;let[t,a]=await Promise.all([(0,f.u7)().catch(()=>[]),(0,f.CS)().catch(()=>[])]),l=d(t,"subjects")?t:[],o=d(a,"notes")?a:[];n(l),s(o),i(!0),u(e)}catch(e){console.warn("數據獲取失敗，使用空數據:",e),n([]),s([])}},[r,c,d]);(0,l.useEffect)(()=>{t("true"===localStorage.getItem("is_paid")),m()},[m]);let[v]=(0,l.useState)({1:{question:"判斷101-200之間有多少個質數並輸出所有質數",userAnswer:"A10個",correctAnswer:"B17個",status:"incorrect"},2:{question:"計算1到100的和",userAnswer:"5050",correctAnswer:"5050",status:"correct"},3:{question:"求斐波那契數列第10項",userAnswer:"34",correctAnswer:"55",status:"incorrect"},4:{question:"判斷一個數是否為回文數",userAnswer:"是",correctAnswer:"是",status:"correct"},5:{question:"求最大公約數",userAnswer:"6",correctAnswer:"12",status:"incorrect"}}),_=(0,l.useCallback)(()=>e,[e]),p=(0,l.useCallback)(()=>{window.showCustomAlert&&window.showCustomAlert("此功能僅限Plus用戶使用，請升級到Plus方案！")},[]),y=(0,l.useCallback)(e=>e.replace(/^### (.*$)/gim,"<h3>$1</h3>").replace(/^## (.*$)/gim,"<h2>$1</h2>").replace(/^# (.*$)/gim,"<h1>$1</h1>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`(.*?)`/g,"<code>$1</code>").replace(/^- (.*$)/gim,"<li>$1</li>").replace(/^---$/gim,"<hr>").replace(/\n/g,"<br>"),[]),g=(0,l.useCallback)((e,t)=>{let a=document.getElementById(e),n=document.getElementById(t);a&&n&&(n.innerHTML=y(a.value))},[y]),h=(0,l.useCallback)(async e=>{if(!_())return void p();try{let t={...e,id:e.id||Date.now(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};s(e=>[...e,t]),a.includes(e.subject)||n(t=>[...t,e.subject]);let l=await (0,f.gp)(t);return l.success||console.warn("筆記同步失敗:",l.message),l}catch(e){return console.warn("添加筆記失敗:",e),{success:!1,message:"保存失敗，請重試！"}}},[_,p,a]);return{questionData:v,subjects:a,notes:o,isPlusSubscribed:e,checkPlusSubscription:_,showUpgradeAlert:p,addNoteToSystem:h,showCustomAlert:(0,l.useCallback)(e=>{window.showCustomAlert&&window.showCustomAlert(e)},[]),showCustomPrompt:(0,l.useCallback)((e,t)=>{window.showGameoverCustomPrompt&&window.showGameoverCustomPrompt(e,t)},[]),parseMarkdown:y,updateContentPreview:g}}(),[ea,en]=(0,l.useState)(null),el=e=>{C(e),h(!0)},eo=(e,t)=>{q(e),T(()=>t),N(!0)},es=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],a=new Map(t.map(e=>[e.topicId,e.selected])),n=e.map((e,t)=>{var n;let l=null!=(n=a.get(e.id))?n:null,o=!!l&&l===e.Ai_answer;return{number:t+1,id:e.id,title:e.title,options:{A:e.option_A,B:e.option_B,C:e.option_C,D:e.option_D},aiAnswer:e.Ai_answer,userSelected:l,isCorrect:o,status:o?"correct":"wrong"}}),l=n.filter(e=>e.isCorrect).length,o=n.length,s=o?Math.round(l/o*100):0;return{merged:n,summary:{total:o,correct:l,wrong:o-l,accuracy:s}}};return(0,l.useEffect)(()=>(window.showCustomAlert=el,window.showGameoverCustomPrompt=eo,window.addNoteToSystem=Z,window.parseMarkdown=ee,window.updateContentPreview=et,window.subjects=K,window.notes=H,()=>{delete window.showCustomAlert,delete window.showGameoverCustomPrompt,delete window.addNoteToSystem,delete window.parseMarkdown,delete window.updateContentPreview,delete window.subjects,delete window.notes}),[el,eo,Z,ee,et,K,H]),(0,l.useEffect)(()=>{try{let e=sessionStorage.getItem("quizData"),t=sessionStorage.getItem("userAnswers");if(!e||!t)return;let a=JSON.parse(e),n=JSON.parse(t);if(!a||!Array.isArray(a.topics)||!Array.isArray(n))return void console.warn("quizData 格式不正確");let{quiz:l,topics:o,question_count:s}=a;L(null!=l?l:null),F(n);let{merged:r,summary:i}=es(o,n);$(r),V({total:Number.isFinite(s)?s:r.length,correct:i.correct,wrong:i.wrong,accuracy:i.accuracy})}catch(e){console.warn("初始化 gameover 資料失敗:",e)}},[]),(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(o.A,{showMenu:!0,isMenuOpen:e,onToggleMenu:()=>{t(!e)},enableNoteQLink:!0}),(0,n.jsxs)("main",{children:[(0,n.jsx)(r,{quiz:D,stats:J,styles:A()})," ",(0,n.jsx)(u,{questionData:M,onOpenFavoriteModal:e=>{var t,a,n;if(!U())return void Y();let l=M[Number.isInteger(e)?e-1:e];if(!l)return;let o=null!=(t=l.options)?t:{A:l.option_A,B:l.option_B,C:l.option_C,D:l.option_D},s=l.userSelected?null!=(a=o[l.userSelected])?a:l.userSelected:"",r=l.aiAnswer?null!=(n=o[l.aiAnswer])?n:l.aiAnswer:"";E({number:l.number,...l,options:o,userAnswerText:s,correctAnswerText:r}),d(!0)},onOpenAnalysis:e=>{if(!U())return void Y();en(e-1),i(!0)},styles:A(),isPlusSubscribed:X})]}),(0,n.jsx)(s.A,{isOpen:e,onClose:()=>{t(!1)},onLogout:S.I}),(0,n.jsx)(_,{isOpen:a,onClose:()=>{i(!1)},onOpenAnalysisFavoriteModal:()=>{if(!U())return void Y();v(!0)},onOpenAnalysisFullFavoriteModal:()=>{if(!U())return void Y();y(!0)},styles:A(),topicIndex:ea}),(0,n.jsx)(b,{isOpen:c,onClose:()=>{d(!1),E(null)},questionData:I,subjects:K,notes:H,onShowCustomAlert:el,onShowCustomPrompt:eo,styles:A()}),(0,n.jsx)(x,{isOpen:m,onClose:()=>{v(!1)},subjects:K,notes:H,onShowCustomAlert:el,onShowCustomPrompt:eo,styles:A()}),(0,n.jsx)(j,{isOpen:p,onClose:()=>{y(!1)},subjects:K,notes:H,onShowCustomAlert:el,onShowCustomPrompt:eo,styles:A()}),(0,n.jsx)(O,{isOpen:g,message:G,onClose:()=>{h(!1)},styles:A()}),(0,n.jsx)(P,{isOpen:w,title:k,onClose:()=>{N(!1),z&&z(null)},onConfirm:e=>{N(!1),z&&z(e)},styles:A()})]})}},6723:(e,t,a)=>{Promise.resolve().then(a.bind(a,5231))},7075:e=>{e.exports={"results-section":"GameOverPage_results-section__aNuU5","results-card":"GameOverPage_results-card__5nJzi","results-title":"GameOverPage_results-title__9TsO1","results-summary":"GameOverPage_results-summary__zQ4rb","questions-grid":"GameOverPage_questions-grid__xYtLD","question-card":"GameOverPage_question-card__7rfFz","card-header":"GameOverPage_card-header__4XtuN","card-title":"GameOverPage_card-title__aVc54","status-tag":"GameOverPage_status-tag__Qjm78",incorrect:"GameOverPage_incorrect__h_LW4",correct:"GameOverPage_correct__jaXTm","card-body":"GameOverPage_card-body__TSSku","card-actions":"GameOverPage_card-actions___yXVs","upgrade-notice":"GameOverPage_upgrade-notice__ZF0dp","action-btn":"GameOverPage_action-btn__NcO3I","btn-favorite":"GameOverPage_btn-favorite__UEA7B","btn-analysis":"GameOverPage_btn-analysis__2mqvb","analysis-overlay":"GameOverPage_analysis-overlay__bz_mE",active:"GameOverPage_active__6kd3U","analysis-header":"GameOverPage_analysis-header__e2j8d","analysis-title":"GameOverPage_analysis-title__7qPrT","close-btn":"GameOverPage_close-btn__N5TAA","analysis-content":"GameOverPage_analysis-content__oDeMp","chat-messages":"GameOverPage_chat-messages__sUaio",message:"GameOverPage_message__MzlU7",ai:"GameOverPage_ai__4a2_f",user:"GameOverPage_user___D9lP",placeholder:"GameOverPage_placeholder__Gq1mj","placeholder-icon":"GameOverPage_placeholder-icon__5iEA_","analysis-input":"GameOverPage_analysis-input__lIUxM","input-field":"GameOverPage_input-field__vTvz3","send-btn":"GameOverPage_send-btn__qND2L","add-icon":"GameOverPage_add-icon__RQey_","overlay-backdrop":"GameOverPage_overlay-backdrop__A6ZuO","favorite-modal":"GameOverPage_favorite-modal__ZVB5s","favorite-modal-content":"GameOverPage_favorite-modal-content__olCLx","favorite-modal-header":"GameOverPage_favorite-modal-header__5yI72","favorite-modal-title":"GameOverPage_favorite-modal-title__uYETV","favorite-modal-close":"GameOverPage_favorite-modal-close__g7MwM","favorite-modal-body":"GameOverPage_favorite-modal-body__Un_tO","favorite-question-info":"GameOverPage_favorite-question-info__Ia0iz","favorite-subject-selector":"GameOverPage_favorite-subject-selector__4Ih4q","favorite-filter-label":"GameOverPage_favorite-filter-label__J9lTF","favorite-select-wrapper":"GameOverPage_favorite-select-wrapper__sHcN3","favorite-custom-select-container":"GameOverPage_favorite-custom-select-container__1LtYy","favorite-custom-select":"GameOverPage_favorite-custom-select__6ONeZ","favorite-select-arrow":"GameOverPage_favorite-select-arrow__6pJKH","favorite-custom-dropdown":"GameOverPage_favorite-custom-dropdown__v2wbu","favorite-dropdown-option":"GameOverPage_favorite-dropdown-option__e0AZh",selected:"GameOverPage_selected__W4O7n","favorite-option-text":"GameOverPage_favorite-option-text__wN7Ek","favorite-note-selector":"GameOverPage_favorite-note-selector__1NwzM","favorite-note-select-wrapper":"GameOverPage_favorite-note-select-wrapper__7SrX3","favorite-note-select-container":"GameOverPage_favorite-note-select-container__n27ps","favorite-note-select":"GameOverPage_favorite-note-select__LFXb8","favorite-note-select-arrow":"GameOverPage_favorite-note-select-arrow__TWB9J","favorite-note-dropdown":"GameOverPage_favorite-note-dropdown__WScyS","favorite-note-dropdown-option":"GameOverPage_favorite-note-dropdown-option__VTQrb","favorite-note-option-text":"GameOverPage_favorite-note-option-text__0TywG","favorite-note-title-input":"GameOverPage_favorite-note-title-input__OnyVx","favorite-note-title-field":"GameOverPage_favorite-note-title-field__ULxxb","content-editor":"GameOverPage_content-editor__xWy1I","content-textarea":"GameOverPage_content-textarea___bLUq","content-preview":"GameOverPage_content-preview__Rp3I4","content-toggle":"GameOverPage_content-toggle__ZXe6N","favorite-modal-footer":"GameOverPage_favorite-modal-footer__E7h2L","favorite-modal-btn":"GameOverPage_favorite-modal-btn__g7uGW","favorite-modal-btn-primary":"GameOverPage_favorite-modal-btn-primary__12vyF","favorite-modal-btn-secondary":"GameOverPage_favorite-modal-btn-secondary__geeLl","analysis-favorite-modal":"GameOverPage_analysis-favorite-modal__Xxsfm","analysis-favorite-modal-content":"GameOverPage_analysis-favorite-modal-content__2L0xm","analysis-favorite-modal-header":"GameOverPage_analysis-favorite-modal-header__V0190","analysis-favorite-modal-title":"GameOverPage_analysis-favorite-modal-title__fwcua","analysis-favorite-modal-close":"GameOverPage_analysis-favorite-modal-close__RMZq9","analysis-favorite-modal-body":"GameOverPage_analysis-favorite-modal-body__xQbmz","analysis-favorite-content-info":"GameOverPage_analysis-favorite-content-info__Kq8TX","analysis-favorite-subject-selector":"GameOverPage_analysis-favorite-subject-selector__f5VNw","analysis-favorite-filter-label":"GameOverPage_analysis-favorite-filter-label__LPOb1","analysis-favorite-select-wrapper":"GameOverPage_analysis-favorite-select-wrapper__QLpGX","analysis-favorite-custom-select-container":"GameOverPage_analysis-favorite-custom-select-container__Et7D9","analysis-favorite-custom-select":"GameOverPage_analysis-favorite-custom-select__p8WLK","analysis-favorite-select-arrow":"GameOverPage_analysis-favorite-select-arrow__srKQr","analysis-favorite-custom-dropdown":"GameOverPage_analysis-favorite-custom-dropdown__tx4HT","analysis-favorite-dropdown-option":"GameOverPage_analysis-favorite-dropdown-option__Ioc72","analysis-favorite-option-text":"GameOverPage_analysis-favorite-option-text__6xyKv","analysis-favorite-note-selector":"GameOverPage_analysis-favorite-note-selector__wodOL","analysis-favorite-note-select-wrapper":"GameOverPage_analysis-favorite-note-select-wrapper__Ihpnd","analysis-favorite-note-select-container":"GameOverPage_analysis-favorite-note-select-container__iW00N","analysis-favorite-note-select":"GameOverPage_analysis-favorite-note-select___KJbO","analysis-favorite-note-select-arrow":"GameOverPage_analysis-favorite-note-select-arrow__SnAhI","analysis-favorite-note-dropdown":"GameOverPage_analysis-favorite-note-dropdown__fAzYk","analysis-favorite-note-dropdown-option":"GameOverPage_analysis-favorite-note-dropdown-option___tE5t","analysis-favorite-note-option-text":"GameOverPage_analysis-favorite-note-option-text__99T4Q","analysis-favorite-note-title-input":"GameOverPage_analysis-favorite-note-title-input__qmiI9","analysis-favorite-note-title-field":"GameOverPage_analysis-favorite-note-title-field__1ff8F","analysis-favorite-modal-footer":"GameOverPage_analysis-favorite-modal-footer__zzKYl","analysis-favorite-modal-btn":"GameOverPage_analysis-favorite-modal-btn__FkhIJ","analysis-favorite-modal-btn-primary":"GameOverPage_analysis-favorite-modal-btn-primary__DNVZv","analysis-favorite-modal-btn-secondary":"GameOverPage_analysis-favorite-modal-btn-secondary__oo_bD","analysis-full-favorite-modal":"GameOverPage_analysis-full-favorite-modal___y_qG","analysis-full-favorite-modal-content":"GameOverPage_analysis-full-favorite-modal-content__zYYoe","analysis-full-favorite-modal-header":"GameOverPage_analysis-full-favorite-modal-header__3E59s","analysis-full-favorite-modal-title":"GameOverPage_analysis-full-favorite-modal-title__PcalX","analysis-full-favorite-modal-close":"GameOverPage_analysis-full-favorite-modal-close__4XUsl","analysis-full-favorite-modal-body":"GameOverPage_analysis-full-favorite-modal-body__oO_sG","analysis-full-favorite-content-info":"GameOverPage_analysis-full-favorite-content-info__MSEVd","analysis-full-favorite-content-text":"GameOverPage_analysis-full-favorite-content-text__mlRLi","analysis-full-favorite-subject-selector":"GameOverPage_analysis-full-favorite-subject-selector__YaPFl","analysis-full-favorite-note-selector":"GameOverPage_analysis-full-favorite-note-selector__FUIN0","analysis-full-favorite-filter-label":"GameOverPage_analysis-full-favorite-filter-label__vbga_","analysis-full-favorite-select-wrapper":"GameOverPage_analysis-full-favorite-select-wrapper__AFEZ2","analysis-full-favorite-note-select-wrapper":"GameOverPage_analysis-full-favorite-note-select-wrapper__aLijM","analysis-full-favorite-custom-select-container":"GameOverPage_analysis-full-favorite-custom-select-container__m87SE","analysis-full-favorite-note-select-container":"GameOverPage_analysis-full-favorite-note-select-container__ibYer","analysis-full-favorite-custom-select":"GameOverPage_analysis-full-favorite-custom-select__sZn7c","analysis-full-favorite-note-select":"GameOverPage_analysis-full-favorite-note-select__iXfVn","analysis-full-favorite-select-arrow":"GameOverPage_analysis-full-favorite-select-arrow__C6M0k","analysis-full-favorite-note-select-arrow":"GameOverPage_analysis-full-favorite-note-select-arrow__yKmPn","analysis-full-favorite-custom-dropdown":"GameOverPage_analysis-full-favorite-custom-dropdown__t9Hcx","analysis-full-favorite-note-dropdown":"GameOverPage_analysis-full-favorite-note-dropdown__7Z2ty","analysis-full-favorite-dropdown-option":"GameOverPage_analysis-full-favorite-dropdown-option__bUjr6","analysis-full-favorite-note-dropdown-option":"GameOverPage_analysis-full-favorite-note-dropdown-option__BoTd9","analysis-full-favorite-option-text":"GameOverPage_analysis-full-favorite-option-text__5Bweb","analysis-full-favorite-note-option-text":"GameOverPage_analysis-full-favorite-note-option-text__ic1xq","analysis-full-favorite-note-title-input":"GameOverPage_analysis-full-favorite-note-title-input__ve1fO","analysis-full-favorite-note-title-field":"GameOverPage_analysis-full-favorite-note-title-field__SSAoW","analysis-full-favorite-modal-footer":"GameOverPage_analysis-full-favorite-modal-footer__zSNN0","analysis-full-favorite-modal-btn":"GameOverPage_analysis-full-favorite-modal-btn__D_YH4","analysis-full-favorite-modal-btn-primary":"GameOverPage_analysis-full-favorite-modal-btn-primary__wkyGe","analysis-full-favorite-modal-btn-secondary":"GameOverPage_analysis-full-favorite-modal-btn-secondary__37uEb","custom-alert-modal":"GameOverPage_custom-alert-modal__K1Mjn","custom-alert-content":"GameOverPage_custom-alert-content__GVGPC","custom-alert-message":"GameOverPage_custom-alert-message__Y2Rli","custom-alert-btn":"GameOverPage_custom-alert-btn__O1dK5","custom-prompt-modal":"GameOverPage_custom-prompt-modal__yLZb0","custom-prompt-content":"GameOverPage_custom-prompt-content__V7yn3","custom-prompt-title":"GameOverPage_custom-prompt-title__dm2qb","custom-prompt-input":"GameOverPage_custom-prompt-input__hYvku","custom-prompt-buttons":"GameOverPage_custom-prompt-buttons__JR2Ce","custom-prompt-btn":"GameOverPage_custom-prompt-btn__9_yMd","custom-prompt-btn-primary":"GameOverPage_custom-prompt-btn-primary__4bH76","custom-prompt-btn-secondary":"GameOverPage_custom-prompt-btn-secondary__vn9KA","details-section":"GameOverPage_details-section__84KMb"}}},e=>{e.O(0,[984,794,259,618,441,964,358],()=>e(e.s=6723)),_N_E=e.O()}]);